# .github/workflows/bot_prosperidad_divina.yml
name: ğŸ™ Bot Prosperidad Divina - Comentarios AutomÃ¡ticos

on:
  schedule:
    # Ejecutar cada 4 horas para mÃ¡xima cobertura
    - cron: '0 */4 * * *'  # 00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC
  workflow_dispatch:  # Permitir ejecuciÃ³n manual

env:
  PYTHON_VERSION: '3.9'

jobs:
  bendecir-comentarios:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Descargar repositorio
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Instalar dependencias
      run: |
        pip install google-generativeai google-api-python-client python-dateutil
        
    - name: ğŸ•’ Obtener fecha y hora actual
      id: datetime
      run: |
        echo "fecha=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "hora=$(date +'%H:%M')" >> $GITHUB_OUTPUT
        echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
        echo "fecha_readable=$(date +'%d de %B')" >> $GITHUB_OUTPUT
        
    - name: ğŸ‘‘ Ejecutar Bot Prosperidad Divina
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python bot_prosperidad_divina_automatico.py
        
    - name: ğŸ“Š Generar reporte de bendiciones
      run: |
        echo "# ğŸ‘‘ Reporte Prosperidad Divina - ${{ steps.datetime.outputs.fecha_readable }} ${{ steps.datetime.outputs.hora }}" > REPORTE_BENDICIONES.md
        echo "" >> REPORTE_BENDICIONES.md
        echo "## âœ¨ Ministerio Digital de Hoy:" >> REPORTE_BENDICIONES.md
        echo "" >> REPORTE_BENDICIONES.md
        
        if [ -f "stats_prosperidad_divina.json" ]; then
          python -c "
import json
import datetime
try:
    with open('stats_prosperidad_divina.json', 'r') as f:
        stats = json.load(f)
    
    print(f\"- ğŸ¯ **Comentarios bendecidos:** {stats.get('respuestas_exitosas', 0)}\")
    print(f\"- ğŸ‘‘ **Gemini Pro usado:** {stats.get('pro_usado', 0)}/46 (calidad premium)\")
    print(f\"- âš¡ **Gemini Flash usado:** {stats.get('flash_usado', 0)}/1450 (respuestas rÃ¡pidas)\")
    print(f\"- ğŸ’« **Total bendiciones:** {stats.get('respuestas_exitosas', 0)}/1496 diarias\")
    print(f\"- ğŸ™ **Peticiones de oraciÃ³n:** {stats.get('peticiones_oracion', 0)}\")
    print(f\"- ğŸ‰ **Testimonios celebrados:** {stats.get('testimonios_prosperidad', 0)}\")
    print(f\"- ğŸ’ **Respuestas de abundancia:** {stats.get('respuestas_abundancia', 0)}\")
    print(f\"- ğŸ“º **Videos monitoreados:** {stats.get('videos_procesados', 0)}\")
    print(f\"- ğŸ“ˆ **Backlog procesado:** {stats.get('backlog_procesado', 0)}\")
    print(f\"- â° **Ãšltima bendiciÃ³n:** {stats.get('ultima_ejecucion', 'N/A')[:16]}\")
    
    # Calcular eficiencia
    total_usado = stats.get('pro_usado', 0) + stats.get('flash_usado', 0)
    eficiencia = (total_usado / 1496) * 100 if total_usado > 0 else 0
    print(f\"- ğŸ“Š **Eficiencia del dÃ­a:** {eficiencia:.1f}% de capacidad usada\")
    
except Exception as e:
    print('- âŒ **Primera ejecuciÃ³n o error en estadÃ­sticas**')
    print(f'- ğŸ”§ **Error:** {str(e)}')
" >> REPORTE_BENDICIONES.md
        else
          echo "- âš ï¸ **Primera ejecuciÃ³n del bot - inicializando sistema**" >> REPORTE_BENDICIONES.md
        fi
        
        echo "" >> REPORTE_BENDICIONES.md
        echo "## ğŸ“º Videos del Ministerio Monitoreados:" >> REPORTE_BENDICIONES.md
        echo "" >> REPORTE_BENDICIONES.md
        
        if [ -f "videos_prosperidad_procesados.json" ]; then
          python -c "
import json
try:
    with open('videos_prosperidad_procesados.json', 'r') as f:
        videos = json.load(f)
    
    for video in videos.get('videos', []):
        titulo = video.get('titulo', 'Video')[:50]
        tipo = video.get('tipo_detectado', 'general')
        
        # Iconos por tipo de video
        iconos = {
            'urgente': 'âš¡',
            'arcangel_miguel': 'âš”ï¸', 
            'jesus': 'âœï¸',
            'bendiciones': 'ğŸ‘‘',
            'oracion': 'ğŸ™',
            'prosperidad': 'ğŸ’',
            'mensaje_general': 'ğŸ“º'
        }
        icono = iconos.get(tipo, 'ğŸ“º')
        
        print(f\"- {icono} **{titulo}{'...' if len(titulo) == 50 else ''}**\")
        print(f\"  - Tipo: {tipo.replace('_', ' ').title()}\")
        print(f\"  - Comentarios nuevos: {video.get('comentarios_nuevos', 0)}\")
        print(f\"  - Bendiciones enviadas: {video.get('respuestas_generadas', 0)}\")
        print(f\"  - Ãšltima revisiÃ³n: {video.get('ultima_revision', 'N/A')[:16]}\")
        print()
except Exception as e:
    print('- âŒ **Error leyendo videos procesados**')
" >> REPORTE_BENDICIONES.md
        else
          echo "- âš ï¸ **Primera ejecuciÃ³n - inicializando monitoreo de videos**" >> REPORTE_BENDICIONES.md
        fi
        
        echo "" >> REPORTE_BENDICIONES.md
        echo "---" >> REPORTE_BENDICIONES.md
        echo "*ğŸ”„ PrÃ³xima ronda de bendiciones en 4 horas*" >> REPORTE_BENDICIONES.md
        echo "*ğŸ’ Expandiendo el Reino digitalmente, un comentario bendecido a la vez*" >> REPORTE_BENDICIONES.md
        echo "*ğŸ‘‘ Prosperity Divina - Ministerio Digital Automatizado*" >> REPORTE_BENDICIONES.md
        
    - name: ğŸ’¾ Guardar registros de bendiciones
      run: |
        git config --local user.email "prosperidad@divina.ministerio"
        git config --local user.name "Bot Prosperidad Divina"
        
        # Agregar todos los archivos generados
        git add .
        
        # Verificar si hay cambios
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No hay nuevas bendiciones para registrar"
        else
          FECHA="${{ steps.datetime.outputs.fecha_readable }}"
          HORA="${{ steps.datetime.outputs.hora }}"
          
          # Obtener estadÃ­sticas para el commit
          if [ -f "stats_prosperidad_divina.json" ]; then
            BENDICIONES=$(python -c "
import json
try:
    with open('stats_prosperidad_divina.json', 'r') as f:
        stats = json.load(f)
    print(stats.get('respuestas_exitosas', 0))
except:
    print('0')
")
          else
            BENDICIONES="0"
          fi
          
          git commit -m "ğŸ‘‘ Bendiciones AutomÃ¡ticas - $FECHA $HORA

ğŸ’ Bendiciones enviadas: $BENDICIONES
ğŸ™ Ministerio digital activo
â° PrÃ³xima ejecuciÃ³n en 4 horas
âœ¨ Prosperidad divina expandiÃ©ndose automÃ¡ticamente"
          
          git push
          
          echo "âœ… Registro de bendiciones guardado en el repositorio"
        fi
        
    - name: ğŸš¨ NotificaciÃ³n de problemas espirituales
      if: failure()
      run: |
        echo "âŒ Hubo un problema en el ministerio digital"
        echo "ğŸ” Revisa los logs para identificar la causa"
        echo "ğŸ’¡ Posibles causas espirituales:"
        echo "   - LÃ­mite de bendiciones diarias alcanzado (1,496)"
        echo "   - Problema de conexiÃ³n con las APIs celestiales"
        echo "   - Error en credenciales del ministerio"
        echo "   - Videos no encontrados o sin comentarios"
        echo "   - Problemas temporales con Gemini o YouTube"
        echo ""
        echo "ğŸ™ El ministerio continuarÃ¡ en la prÃ³xima ejecuciÃ³n"
        echo "ğŸ‘‘ La prosperidad divina no se detiene"
        
    - name: ğŸ‰ CelebraciÃ³n de Ã©xito ministerial  
      if: success()
      run: |
        echo "âœ… Â¡Ronda de bendiciones completada exitosamente!"
        echo "ğŸ‘‘ Prosperidad Divina expandiÃ©ndose automÃ¡ticamente"
        echo "ğŸ’ Vidas tocadas por mensajes de abundancia"
        echo "ğŸ”„ Sistema preparado para la prÃ³xima bendiciÃ³n"
        echo "â° Nos vemos en 4 horas para mÃ¡s ministerio digital"
