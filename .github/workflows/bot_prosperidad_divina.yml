name: ğŸ™ Bot Prosperidad Divina - Comentarios AutomÃ¡ticos

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'

jobs:
  bendecir-comentarios:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Descargar repositorio
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Instalar dependencias
      run: |
        pip install google-generativeai google-api-python-client python-dateutil
        
    - name: ğŸ•’ Obtener fecha y hora actual
      id: datetime
      run: |
        echo "fecha=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "hora=$(date +'%H:%M')" >> $GITHUB_OUTPUT
        echo "fecha_readable=$(date +'%d de %B')" >> $GITHUB_OUTPUT
        
    - name: ğŸ‘‘ Ejecutar Bot Prosperidad Divina
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python bot_prosperidad_divina_automatico.py
        
    - name: ğŸ“Š Crear script de reporte
      run: |
        cat > generar_reporte.py << 'EOF'
        import json
        import os
        from datetime import datetime
        
        # Obtener fecha del environment
        fecha = os.environ.get('FECHA_READABLE', 'Hoy')
        hora = os.environ.get('HORA', '00:00')
        
        # Crear reporte base
        reporte = f"""# ğŸ‘‘ Reporte Prosperidad Divina - {fecha} {hora}

## âœ¨ Ministerio Digital de Hoy:

"""
        
        # Leer estadÃ­sticas si existen
        try:
            with open('stats_prosperidad_divina.json', 'r') as f:
                stats = json.load(f)
            
            reporte += f"- ğŸ¯ **Comentarios bendecidos:** {stats.get('respuestas_exitosas', 0)}\n"
            reporte += f"- ğŸ‘‘ **Gemini Pro usado:** {stats.get('pro_usado', 0)}/46 (calidad premium)\n"
            reporte += f"- âš¡ **Gemini Flash usado:** {stats.get('flash_usado', 0)}/1450 (respuestas rÃ¡pidas)\n"
            reporte += f"- ğŸ’« **Total bendiciones:** {stats.get('respuestas_exitosas', 0)}/1496 diarias\n"
            reporte += f"- ğŸ™ **Peticiones de oraciÃ³n:** {stats.get('peticiones_oracion', 0)}\n"
            reporte += f"- ğŸ‰ **Testimonios celebrados:** {stats.get('testimonios_prosperidad', 0)}\n"
            reporte += f"- ğŸ’ **Respuestas de abundancia:** {stats.get('respuestas_abundancia', 0)}\n"
            reporte += f"- ğŸ“º **Videos monitoreados:** {stats.get('videos_procesados', 0)}\n"
            reporte += f"- ğŸ“ˆ **Backlog procesado:** {stats.get('backlog_procesado', 0)}\n"
            reporte += f"- â° **Ãšltima bendiciÃ³n:** {stats.get('ultima_ejecucion', 'N/A')[:16]}\n"
            
            # Calcular eficiencia
            total_usado = stats.get('pro_usado', 0) + stats.get('flash_usado', 0)
            eficiencia = (total_usado / 1496) * 100 if total_usado > 0 else 0
            reporte += f"- ğŸ“Š **Eficiencia del dÃ­a:** {eficiencia:.1f}% de capacidad usada\n"
            
        except FileNotFoundError:
            reporte += "- âš ï¸ **Primera ejecuciÃ³n del bot - inicializando sistema**\n"
        except Exception as e:
            reporte += f"- âŒ **Error leyendo estadÃ­sticas:** {str(e)}\n"
        
        reporte += """

## ğŸ“º Videos del Ministerio Monitoreados:

"""
        
        # Leer videos procesados si existen
        try:
            with open('videos_prosperidad_procesados.json', 'r') as f:
                videos = json.load(f)
            
            iconos = {
                'urgente': 'âš¡',
                'arcangel_miguel': 'âš”ï¸', 
                'jesus': 'âœï¸',
                'bendiciones': 'ğŸ‘‘',
                'oracion': 'ğŸ™',
                'prosperidad': 'ğŸ’',
                'mensaje_general': 'ğŸ“º'
            }
            
            for video in videos.get('videos', []):
                titulo = video.get('titulo', 'Video')[:50]
                tipo = video.get('tipo_detectado', 'general')
                icono = iconos.get(tipo, 'ğŸ“º')
                
                reporte += f"- {icono} **{titulo}{'...' if len(titulo) == 50 else ''}**\n"
                reporte += f"  - Tipo: {tipo.replace('_', ' ').title()}\n"
                reporte += f"  - Comentarios nuevos: {video.get('comentarios_nuevos', 0)}\n"
                reporte += f"  - Bendiciones enviadas: {video.get('respuestas_generadas', 0)}\n"
                reporte += f"  - Ãšltima revisiÃ³n: {video.get('ultima_revision', 'N/A')[:16]}\n\n"
                
        except FileNotFoundError:
            reporte += "- âš ï¸ **Primera ejecuciÃ³n - inicializando monitoreo de videos**\n"
        except Exception as e:
            reporte += f"- âŒ **Error leyendo videos procesados:** {str(e)}\n"
        
        reporte += """
---
*ğŸ”„ PrÃ³xima ronda de bendiciones en 4 horas*  
*ğŸ’ Expandiendo el Reino digitalmente, un comentario bendecido a la vez*  
*ğŸ‘‘ Prosperidad Divina - Ministerio Digital Automatizado*
"""
        
        # Guardar reporte
        with open('REPORTE_BENDICIONES.md', 'w', encoding='utf-8') as f:
            f.write(reporte)
        
        print("ğŸ“Š Reporte de bendiciones generado exitosamente")
        EOF
        
    - name: ğŸ“Š Generar reporte de bendiciones
      env:
        FECHA_READABLE: ${{ steps.datetime.outputs.fecha_readable }}
        HORA: ${{ steps.datetime.outputs.hora }}
      run: |
        python generar_reporte.py
        
    - name: ğŸ’¾ Guardar registros de bendiciones
      run: |
        git config --local user.email "prosperidad@divina.ministerio"
        git config --local user.name "Bot Prosperidad Divina"
        
        git add .
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No hay nuevas bendiciones para registrar"
        else
          FECHA="${{ steps.datetime.outputs.fecha_readable }}"
          HORA="${{ steps.datetime.outputs.hora }}"
          
          BENDICIONES="0"
          if [ -f "stats_prosperidad_divina.json" ]; then
            BENDICIONES=$(python -c "
import json
try:
    with open('stats_prosperidad_divina.json', 'r') as f:
        stats = json.load(f)
    print(stats.get('respuestas_exitosas', 0))
except:
    print('0')
")
          fi
          
          git commit -m "ğŸ‘‘ Bendiciones AutomÃ¡ticas - $FECHA $HORA

ğŸ’ Bendiciones enviadas: $BENDICIONES
ğŸ™ Ministerio digital activo
â° PrÃ³xima ejecuciÃ³n en 4 horas
âœ¨ Prosperidad divina expandiÃ©ndose automÃ¡ticamente"
          
          git push
          
          echo "âœ… Registro de bendiciones guardado en el repositorio"
        fi
        
    - name: ğŸš¨ NotificaciÃ³n de problemas
      if: failure()
      run: |
        echo "âŒ Hubo un problema en el ministerio digital"
        echo "ğŸ” Revisa los logs para identificar la causa"
        echo "ğŸ™ El ministerio continuarÃ¡ en la prÃ³xima ejecuciÃ³n"
        
    - name: ğŸ‰ CelebraciÃ³n de Ã©xito
      if: success()
      run: |
        echo "âœ… Â¡Ronda de bendiciones completada exitosamente!"
        echo "ğŸ‘‘ Prosperidad Divina expandiÃ©ndose automÃ¡ticamente"
        echo "â° Nos vemos en 4 horas para mÃ¡s ministerio digital"
