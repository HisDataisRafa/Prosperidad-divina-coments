# Workflow mejorado con persistencia real de memoria de conversaciones
name: ğŸ™ Bot Prosperidad Divina - Ejecutor con Memoria Persistente

# CuÃ¡ndo ejecutar
on:
  # Cada hora en punto
  schedule:
    - cron: '0 * * * *'
  
  # EjecuciÃ³n manual desde GitHub
  workflow_dispatch:

# Permisos necesarios para que el bot pueda hacer commits
permissions:
  contents: write
  actions: read

jobs:
  bendecir-comentarios:
    runs-on: ubuntu-latest
    
    steps:
    # Paso 1: Descargar cÃ³digo y archivos de memoria existentes
    - name: ğŸ“¥ Descargar repositorio y memoria existente
      uses: actions/checkout@v4
      with:
        # Importante: obtener todo el historial para poder hacer push
        fetch-depth: 0
        # Usar token personal para permitir commits
        token: ${{ secrets.GITHUB_TOKEN }}
        
    # Paso 2: Configurar Python
    - name: ğŸ Configurar Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    # Paso 3: Instalar dependencias
    - name: ğŸ“¦ Instalar librerÃ­as necesarias
      run: |
        pip install google-generativeai google-auth google-auth-oauthlib google-api-python-client python-dateutil
        
    # Paso 4: Verificar archivos de memoria existentes
    - name: ğŸ” Verificar estado de archivos de memoria
      run: |
        echo "ğŸ“‚ Contenido actual del directorio:"
        ls -la
        echo ""
        if [ -f "comentarios_respondidos.txt" ]; then
          echo "âœ… Archivo de comentarios respondidos encontrado:"
          echo "   - LÃ­neas: $(wc -l < comentarios_respondidos.txt)"
        else
          echo "âš ï¸  Archivo comentarios_respondidos.txt no existe (se crearÃ¡)"
        fi
        
        if [ -f "memoria_conversaciones.json" ]; then
          echo "âœ… Archivo de memoria de conversaciones encontrado:"
          echo "   - TamaÃ±o: $(du -h memoria_conversaciones.json | cut -f1)"
        else
          echo "âš ï¸  Archivo memoria_conversaciones.json no existe (se crearÃ¡)"
        fi

    # Paso 5: Ejecutar el bot con contexto persistente
    - name: ğŸ‘‘ Ejecutar Bot con Memoria Persistente
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        YOUTUBE_CREDENTIALS_COMMENTS: ${{ secrets.YOUTUBE_CREDENTIALS_COMMENTS }}
      run: |
        echo "ğŸš€ Iniciando Bot Prosperidad Divina con contexto persistente..."
        python bot_prosperidad_divina.py
        echo "âœ… EjecuciÃ³n del bot completada"

    # Paso 6: Verificar quÃ© archivos se crearon o modificaron
    - name: ğŸ” Verificar cambios generados
      run: |
        echo "ğŸ“Š Estado despuÃ©s de la ejecuciÃ³n:"
        echo ""
        
        if [ -f "comentarios_respondidos.txt" ]; then
          echo "âœ… comentarios_respondidos.txt:"
          echo "   - LÃ­neas: $(wc -l < comentarios_respondidos.txt)"
        fi
        
        if [ -f "memoria_conversaciones.json" ]; then
          echo "âœ… memoria_conversaciones.json:"
          echo "   - TamaÃ±o: $(du -h memoria_conversaciones.json | cut -f1)"
          echo "   - Usuarios en memoria: $(grep -o '"autor_id"' memoria_conversaciones.json | wc -l)"
        fi
        
        echo ""
        echo "ğŸ“‹ Reportes generados:"
        ls -la reporte_*.json 2>/dev/null || echo "   (No se generaron reportes en esta ejecuciÃ³n)"
        
        echo ""
        echo "ğŸ”„ Cambios en Git:"
        git status --porcelain

    # Paso 7: Configurar Git y hacer commit de todos los cambios
    - name: ğŸ’¾ Guardar memoria y reportes en el repositorio
      run: |
        # Configurar Git
        git config --local user.email "action@github.com"
        git config --local user.name "Bot Prosperidad Divina"
        
        # ğŸ”§ SOLUCIÃ“N AL PROBLEMA DE GIT: Pull antes de cualquier operaciÃ³n
        echo "ğŸ”„ Sincronizando con repositorio remoto..."
        git pull --rebase origin main || {
          echo "âš ï¸  Problema con pull, intentando merge..."
          git pull --no-rebase origin main || echo "âš ï¸  Pull fallÃ³, continuando..."
        }
        
        # AÃ±adir todos los archivos importantes
        git add comentarios_respondidos.txt memoria_conversaciones.json reporte_*.json
        
        # Verificar si hay cambios para commitear
        if ! git diff --staged --quiet; then
          # Crear commit con informaciÃ³n detallada
          FECHA=$(date +'%d/%m/%Y %H:%M')
          COMENTARIOS_TOTAL=$(wc -l < comentarios_respondidos.txt 2>/dev/null || echo "0")
          
          if [ -f "memoria_conversaciones.json" ]; then
            USUARIOS_MEMORIA=$(grep -c '"autor_id"' memoria_conversaciones.json 2>/dev/null || echo "0")
          else
            USUARIOS_MEMORIA="0"
          fi
          
          git commit -m "ğŸ§  Memoria Actualizada - $FECHA | ğŸ“Š Comentarios: $COMENTARIOS_TOTAL | ğŸ‘¥ Usuarios: $USUARIOS_MEMORIA | âœ¨ Bendiciones completadas"
          
          # ğŸ”§ PUSH CON RETRY Y FORCE SI ES NECESARIO
          echo "ğŸ“¤ Intentando push..."
          if ! git push origin main; then
            echo "âš ï¸  Push normal fallÃ³, intentando pull + push..."
            git pull --rebase origin main || git pull --no-rebase origin main
            git push origin main || {
              echo "âš ï¸  Push con rebase fallÃ³, usando force push (CUIDADO)..."
              git push --force-with-lease origin main
            }
          fi
          
          echo "âœ… Memoria y reportes guardados exitosamente"
          echo "ğŸ“ˆ Total comentarios en BD: $COMENTARIOS_TOTAL"
          echo "ğŸ§  Total usuarios con historial: $USUARIOS_MEMORIA"
          
        else
          echo "â„¹ï¸  No hubo cambios en esta ejecuciÃ³n (no se encontraron comentarios nuevos para responder)"
        fi

    # Paso 8: Limpieza opcional de reportes antiguos (mantener solo Ãºltimos 10)
    - name: ğŸ§¹ Limpieza de reportes antiguos
      run: |
        echo "ğŸ—‚ï¸  Limpiando reportes antiguos (manteniendo Ãºltimos 10)..."
        REPORTES_COUNT=$(ls reporte_*.json 2>/dev/null | wc -l)
        
        if [ "$REPORTES_COUNT" -gt 10 ]; then
          echo "   ğŸ“Š Reportes actuales: $REPORTES_COUNT"
          # Eliminar reportes mÃ¡s antiguos, manteniendo solo los 10 mÃ¡s recientes
          ls -t reporte_*.json | tail -n +11 | xargs rm -f
          
          # Si se eliminaron reportes, commitear la limpieza
          git add . 
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ§¹ Limpieza automÃ¡tica: reportes antiguos eliminados"
            git push origin main || git push --force-with-lease origin main
            echo "   âœ… Reportes antiguos eliminados y cambios guardados"
          fi
        else
          echo "   âœ… Solo $REPORTES_COUNT reportes, no se requiere limpieza"
        fi
        
    # Paso 9: Mensaje de Ã©xito
    - name: ğŸ‰ ConfirmaciÃ³n final
      if: success()
      run: |
        echo ""
        echo "ğŸŒŸ Â¡CICLO DE BENDICIONES COMPLETADO EXITOSAMENTE! ğŸŒŸ"
        echo ""
        echo "ğŸ“… PrÃ³xima ejecuciÃ³n programada: En 1 hora"
        echo "ğŸ”„ El contexto de usuarios se ha mantenido entre ejecuciones"
        echo "ğŸ’« Las bendiciones continÃºan fluyendo..."
        echo ""
        
    # Paso 10: Manejo de errores
    - name: ğŸš¨ Manejo de errores
      if: failure()
      run: |
        echo ""
        echo "âŒ HUBO UN PROBLEMA EN ESTA EJECUCIÃ“N"
        echo ""
        echo "ğŸ” Posibles causas:"
        echo "   â€¢ Error en las APIs (YouTube/Gemini)"
        echo "   â€¢ Problemas de conectividad"
        echo "   â€¢ LÃ­mites de cuota excedidos"
        echo "   â€¢ Conflictos de Git (ahora manejados automÃ¡ticamente)"
        echo ""
        echo "ğŸ”„ El bot lo intentarÃ¡ automÃ¡ticamente en la prÃ³xima ejecuciÃ³n"
        echo "ğŸ’¾ La memoria existente se mantiene intacta"
        echo ""
