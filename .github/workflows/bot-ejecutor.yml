name: Generador de Horarios Aleatorios

on:
  schedule:
    - cron: '0 5 * * *'  # 5:00 AM diariamente
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  generar-horarios-aleatorios:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Generar 20 horarios aleatorios para hoy
      run: |
        echo "Generando horarios aleatorios para $(date +%Y-%m-%d)"
        
        # 20 horas distribuidas a lo largo del día
        HORAS=(6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 0 1)
        
        # Crear bot-ejecutor.yml directamente
        cat > bot-ejecutor.yml << 'EOF'
        name: Bot Prosperidad Divina - Ejecución Aleatoria
        
        on:
          schedule:
        EOF
        
        # Generar horarios con minutos aleatorios
        for hora in "${HORAS[@]}"; do
          minuto=$((1 + RANDOM % 59))
          echo "    - cron: '${minuto} ${hora} * * *'" >> bot-ejecutor.yml
          echo "  Generado: ${hora}:$(printf "%02d" $minuto)"
        done
        
        # Completar bot-ejecutor.yml
        cat >> bot-ejecutor.yml << 'EOF'
          workflow_dispatch:
        
        permissions:
          contents: write
          actions: read
        
        jobs:
          ejecutar-bot:
            runs-on: ubuntu-latest
            steps:
            - name: Checkout
              uses: actions/checkout@v4
              
            - name: Setup Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.9'
                
            - name: Install dependencies
              run: |
                pip install google-generativeai google-auth google-auth-oauthlib google-api-python-client python-dateutil
                
            - name: Ejecutar Bot (5 comentarios exactos)
              env:
                GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                YOUTUBE_CREDENTIALS_COMMENTS: ${{ secrets.YOUTUBE_CREDENTIALS_COMMENTS }}
              run: |
                echo "Ejecutando bot: 5 comentarios exactos"
                echo "Horario aleatorio: $(date +'%H:%M')"
                python bot_prosperidad_divina.py
                
            - name: Guardar cambios
              run: |
                git config --local user.email "action@github.com"
                git config --local user.name "Bot 6000pts"
                git add .
                if ! git diff --staged --quiet; then
                  git commit -m "6000pts - $(date +'%d/%m %H:%M') - 5 comentarios"
                  git push origin main || git push --force-with-lease origin main
                fi
        EOF
        
        echo "bot-ejecutor.yml creado con 20 horarios aleatorios"
        
    - name: Commitear bot-ejecutor.yml
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Generador Horarios"
        git add bot-ejecutor.yml
        git commit -m "Horarios aleatorios para $(date +%Y-%m-%d)" || echo "Sin cambios"
        git push origin main || git push --force-with-lease origin main
