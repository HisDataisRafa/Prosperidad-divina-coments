# Workflow optimizado para 800 RPD con memoria persistente
name: ğŸ¯ Bot Prosperidad Divina - 800 RPD Optimizado

# ConfiguraciÃ³n para 800 RPD
on:
  # Cada 30 minutos para lograr 800 RPD
  schedule:
    - cron: '0,30 * * * *'  # 48 ejecuciones/dÃ­a Ã— 17 comentarios = 816 RPD
  
  # EjecuciÃ³n manual
  workflow_dispatch:

# Permisos necesarios
permissions:
  contents: write
  actions: read

jobs:
  bendecir-comentarios-800rpd:
    runs-on: ubuntu-latest
    
    steps:
    # Paso 1: Descargar repositorio y memoria
    - name: ğŸ“¥ Descargar repositorio y memoria existente
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    # Paso 2: Configurar Python
    - name: ğŸ Configurar Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    # Paso 3: Instalar dependencias
    - name: ğŸ“¦ Instalar librerÃ­as necesarias
      run: |
        pip install google-generativeai google-auth google-auth-oauthlib google-api-python-client python-dateutil
        
    # Paso 4: Verificar memoria existente
    - name: ğŸ” Verificar estado de archivos de memoria
      run: |
        echo "ğŸ“‚ ESTADO ACTUAL - CONFIGURACIÃ“N 800 RPD:"
        ls -la
        echo ""
        
        if [ -f "comentarios_respondidos.txt" ]; then
          LINEAS=$(wc -l < comentarios_respondidos.txt)
          echo "âœ… Comentarios respondidos: $LINEAS"
          echo "   - Ãšltimas 3 lÃ­neas:"
          tail -3 comentarios_respondidos.txt | sed 's/^/     /'
        else
          echo "âš ï¸  comentarios_respondidos.txt no existe (se crearÃ¡)"
        fi
        
        if [ -f "memoria_conversaciones.json" ]; then
          USUARIOS=$(grep -c '"autor_id"' memoria_conversaciones.json 2>/dev/null || echo "0")
          echo "âœ… Memoria conversaciones:"
          echo "   - TamaÃ±o: $(du -h memoria_conversaciones.json | cut -f1)"
          echo "   - Usuarios: $USUARIOS"
        else
          echo "âš ï¸  memoria_conversaciones.json no existe (se crearÃ¡)"
        fi
        
        echo ""
        echo "ğŸ¯ CONFIGURACIÃ“N 800 RPD:"
        echo "   - EjecuciÃ³n: Cada 30 minutos (48/dÃ­a)"
        echo "   - Comentarios por ejecuciÃ³n: 17"
        echo "   - RPD objetivo: 816"
        echo "   - Modelo: Gemini 2.5 Flash-Lite (1,000 RPD)"

    # Paso 5: Ejecutar bot 800 RPD
    - name: ğŸ¯ Ejecutar Bot 800 RPD Optimizado
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        YOUTUBE_CREDENTIALS_COMMENTS: ${{ secrets.YOUTUBE_CREDENTIALS_COMMENTS }}
      run: |
        echo "ğŸš€ INICIANDO BOT 800 RPD..."
        echo "â° Inicio: $(date +'%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ¯ Objetivo esta ejecuciÃ³n: 17 comentarios"
        echo ""
        
        python bot_prosperidad_divina.py
        
        echo ""
        echo "âœ… EjecuciÃ³n 800 RPD completada"
        echo "â° Fin: $(date +'%Y-%m-%d %H:%M:%S UTC')"

    # Paso 6: Verificar resultados 800 RPD
    - name: ğŸ” Verificar resultados 800 RPD
      run: |
        echo "ğŸ“Š RESULTADOS DE ESTA EJECUCIÃ“N 800 RPD:"
        echo ""
        
        if [ -f "comentarios_respondidos.txt" ]; then
          LINEAS_NUEVAS=$(wc -l < comentarios_respondidos.txt)
          echo "âœ… comentarios_respondidos.txt:"
          echo "   - Total lÃ­neas: $LINEAS_NUEVAS"
          if [ "$LINEAS_NUEVAS" -gt 0 ]; then
            echo "   - Ãšltimas 5 respuestas:"
            tail -5 comentarios_respondidos.txt | sed 's/^/     /'
          fi
        fi
        
        if [ -f "memoria_conversaciones.json" ]; then
          USUARIOS=$(grep -c '"autor_id"' memoria_conversaciones.json 2>/dev/null || echo "0")
          echo "âœ… memoria_conversaciones.json:"
          echo "   - TamaÃ±o: $(du -h memoria_conversaciones.json | cut -f1)"
          echo "   - Usuarios en memoria: $USUARIOS"
        fi
        
        echo ""
        echo "ğŸ“‹ Reportes generados:"
        REPORTES_800RPD=$(ls -la reporte_*.json 2>/dev/null | wc -l)
        if [ "$REPORTES_800RPD" -gt 0 ]; then
          ls -la reporte_*.json | tail -1
          echo "   ğŸ“ˆ Total reportes: $REPORTES_800RPD"
          
          # Extraer estadÃ­sticas del Ãºltimo reporte
          ULTIMO_REPORTE=$(ls -t reporte_*.json 2>/dev/null | head -1)
          if [ -f "$ULTIMO_REPORTE" ]; then
            RESPUESTAS=$(grep '"respuestas_exitosas"' "$ULTIMO_REPORTE" | grep -o '[0-9]*' | tail -1)
            PROCESADOS=$(grep '"comentarios_procesados"' "$ULTIMO_REPORTE" | grep -o '[0-9]*' | tail -1)
            echo "   ğŸ“Š Esta ejecuciÃ³n: $RESPUESTAS respuestas de $PROCESADOS procesados"
          fi
        else
          echo "   (No se generaron reportes en esta ejecuciÃ³n)"
        fi
        
        echo ""
        echo "ğŸ”„ Cambios pendientes en Git:"
        git status --porcelain

    # Paso 7: Guardar memoria y proyectar 800 RPD
    - name: ğŸ’¾ Guardar memoria y calcular proyecciÃ³n 800 RPD
      run: |
        # Configurar Git
        git config --local user.email "action@github.com"
        git config --local user.name "Bot Prosperidad Divina 800RPD"
        
        # SincronizaciÃ³n con repositorio remoto
        echo "ğŸ”„ Sincronizando repositorio..."
        git pull --rebase origin main || {
          echo "âš ï¸  Rebase fallÃ³, intentando merge..."
          git pull --no-rebase origin main || echo "âš ï¸  Continuando sin pull..."
        }
        
        # AÃ±adir archivos importantes
        git add comentarios_respondidos.txt memoria_conversaciones.json reporte_*.json
        
        # Verificar cambios
        if ! git diff --staged --quiet; then
          # Calcular estadÃ­sticas para 800 RPD
          FECHA=$(date +'%d/%m/%Y %H:%M UTC')
          COMENTARIOS_TOTAL=$(wc -l < comentarios_respondidos.txt 2>/dev/null || echo "0")
          
          if [ -f "memoria_conversaciones.json" ]; then
            USUARIOS_MEMORIA=$(grep -c '"autor_id"' memoria_conversaciones.json 2>/dev/null || echo "0")
          else
            USUARIOS_MEMORIA="0"
          fi
          
          # Extraer estadÃ­sticas del Ãºltimo reporte
          ULTIMO_REPORTE=$(ls -t reporte_*.json 2>/dev/null | head -1)
          if [ -f "$ULTIMO_REPORTE" ]; then
            RESPUESTAS_ESTA_EJECUCION=$(grep '"respuestas_exitosas"' "$ULTIMO_REPORTE" | grep -o '[0-9]*' | tail -1)
            GEMINI_EXITOSAS=$(grep '"respuestas_ia_exitosas"' "$ULTIMO_REPORTE" | grep -o '[0-9]*' | tail -1)
            DURACION=$(grep '"duracion_minutos"' "$ULTIMO_REPORTE" | grep -o '[0-9.]*' | tail -1)
          else
            RESPUESTAS_ESTA_EJECUCION="0"
            GEMINI_EXITOSAS="0"
            DURACION="0"
          fi
          
          # ProyecciÃ³n diaria para 800 RPD
          if [ "$RESPUESTAS_ESTA_EJECUCION" -gt 0 ]; then
            PROYECCION_DIARIA=$((RESPUESTAS_ESTA_EJECUCION * 48))
            PORCENTAJE_800=$((PROYECCION_DIARIA * 100 / 800))
          else
            PROYECCION_DIARIA="0"
            PORCENTAJE_800="0"
          fi
          
          # Commit con informaciÃ³n detallada para 800 RPD
          git commit -m "ğŸ¯ 800RPD Update - $FECHA | ğŸ“Š Total: $COMENTARIOS_TOTAL | ğŸ‘¥ Users: $USUARIOS_MEMORIA | âœ¨ Esta exec: $RESPUESTAS_ESTA_EJECUCION | ğŸ¤– Gemini: $GEMINI_EXITOSAS | ğŸ“ˆ ProyecciÃ³n: ${PROYECCION_DIARIA}RPD (${PORCENTAJE_800}%)"
          
          # Push con mÃºltiples intentos
          echo "ğŸ“¤ Guardando cambios..."
          PUSH_SUCCESS=false
          
          if git push origin main; then
            PUSH_SUCCESS=true
          elif git pull --rebase origin main && git push origin main; then
            PUSH_SUCCESS=true
          elif git pull --no-rebase origin main && git push origin main; then
            PUSH_SUCCESS=true
          elif git push --force-with-lease origin main; then
            PUSH_SUCCESS=true
            echo "âš ï¸  Usado force push - revisar manualmente"
          fi
          
          if [ "$PUSH_SUCCESS" = true ]; then
            echo "âœ… Memoria guardada exitosamente"
            echo ""
            echo "ğŸ“Š ESTADÃSTICAS 800 RPD:"
            echo "   - Total comentarios BD: $COMENTARIOS_TOTAL"
            echo "   - Usuarios en memoria: $USUARIOS_MEMORIA"
            echo "   - Esta ejecuciÃ³n: $RESPUESTAS_ESTA_EJECUCION respuestas"
            echo "   - Gemini exitosas: $GEMINI_EXITOSAS"
            echo "   - DuraciÃ³n: ${DURACION} minutos"
            echo "   - ProyecciÃ³n diaria: ${PROYECCION_DIARIA} RPD"
            echo "   - Progreso hacia 800: ${PORCENTAJE_800}%"
          else
            echo "âŒ ERROR: Push fallÃ³ despuÃ©s de mÃºltiples intentos"
            exit 1
          fi
          
        else
          echo "â„¹ï¸  Sin cambios en esta ejecuciÃ³n"
          echo "ğŸ’¡ Posibles razones:"
          echo "   â€¢ No habÃ­a comentarios nuevos disponibles"
          echo "   â€¢ Todos los comentarios recientes ya fueron procesados"
          echo "   â€¢ Comentarios filtrados por criterios de validaciÃ³n"
        fi

    # Paso 8: Limpieza inteligente para 800 RPD
    - name: ğŸ§¹ Limpieza optimizada para 800 RPD
      run: |
        echo "ğŸ—‚ï¸  GestiÃ³n de reportes (800 RPD genera ~48 reportes/dÃ­a)..."
        REPORTES_COUNT=$(ls reporte_*.json 2>/dev/null | wc -l)
        
        # Para 800 RPD, mantener reportes de Ãºltimos 2 dÃ­as (96 reportes)
        if [ "$REPORTES_COUNT" -gt 96 ]; then
          echo "   ğŸ“Š Reportes actuales: $REPORTES_COUNT"
          echo "   ğŸ§¹ Manteniendo Ãºltimos 96 reportes (2 dÃ­as de 800 RPD)"
          
          # Eliminar reportes mÃ¡s antiguos
          ls -t reporte_*.json | tail -n +97 | xargs rm -f
          
          # Commitear limpieza si hay cambios
          git add . 
          if ! git diff --staged --quiet; then
            ELIMINADOS=$((REPORTES_COUNT - 96))
            git commit -m "ğŸ§¹ Limpieza 800RPD: $ELIMINADOS reportes antiguos eliminados (mantenidos 96)"
            
            if git push origin main || git push --force-with-lease origin main; then
              echo "   âœ… $ELIMINADOS reportes eliminados y guardado"
            else
              echo "   âš ï¸  Limpieza OK, push fallÃ³ (no crÃ­tico)"
            fi
          fi
        else
          echo "   âœ… $REPORTES_COUNT reportes, no requiere limpieza"
        fi

    # Paso 9: Mensaje de Ã©xito 800 RPD
    - name: ğŸ‰ ConfirmaciÃ³n final 800 RPD
      if: success()
      run: |
        echo ""
        echo "ğŸ¯ Â¡EJECUCIÃ“N 800 RPD COMPLETADA EXITOSAMENTE! ğŸ¯"
        echo ""
        echo "ğŸ“Š CONFIGURACIÃ“N ACTIVA:"
        echo "   ğŸ¤– Modelo: Gemini 2.5 Flash-Lite"
        echo "   â° Frecuencia: Cada 30 minutos (48 ejecuciones/dÃ­a)"
        echo "   ğŸ“ Comentarios/ejecuciÃ³n: 17"
        echo "   ğŸ¯ Objetivo diario: 800 RPD"
        echo "   ğŸ“ˆ ProyecciÃ³n real: 816 RPD"
        echo "   ğŸ›¡ï¸  Margen de seguridad: 184 RPD disponibles"
        echo ""
        echo "ğŸ”„ PRÃ“XIMA EJECUCIÃ“N: En 30 minutos"
        echo "ğŸ’¾ Memoria persistente mantenida entre ejecuciones"
        echo "ğŸ“Š Reportes detallados generados automÃ¡ticamente"
        echo "âœ¨ Las bendiciones fluyen de manera optimizada"
        echo ""
        
    # Paso 10: Manejo de errores para 800 RPD
    - name: ğŸš¨ Manejo de errores 800 RPD
      if: failure()
      run: |
        echo ""
        echo "âŒ ERROR EN EJECUCIÃ“N 800 RPD"
        echo ""
        echo "ğŸ” DiagnÃ³stico para configuraciÃ³n 800 RPD:"
        echo "   â€¢ Error en APIs (YouTube/Gemini Flash-Lite)"
        echo "   â€¢ LÃ­mites de cuota 1,000 RPD excedidos (improbable)"
        echo "   â€¢ Conectividad intermitente"
        echo "   â€¢ Insuficientes comentarios nuevos disponibles"
        echo "   â€¢ Conflictos Git (manejo automÃ¡tico implementado)"
        echo ""
        echo "ğŸ”„ RECUPERACIÃ“N AUTOMÃTICA:"
        echo "   â€¢ PrÃ³ximo intento en 30 minutos"
        echo "   â€¢ Memoria existente preservada"
        echo "   â€¢ ConfiguraciÃ³n 800 RPD mantenida"
        echo "   â€¢ 47 oportunidades mÃ¡s hoy para alcanzar objetivo"
        echo ""
